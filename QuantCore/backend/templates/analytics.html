{% extends 'base.html' %}

{% block content %}
<h1>Stock Analytics and Predictions</h1>

<div class="stock-container">
    <form id="stockForm">
        <label for="ticker">Enter Stock Ticker:</label>
        <input type="text" id="ticker" name="ticker" placeholder="e.g., AAPL" required>
        <button type="submit">Analyze</button>
    </form>

    <div id="loading" style="display:none;">Loading data, please wait...</div>
    <div id="error-message" class="error"></div>

    <div id="results" style="display:none;">
        <h2>Results</h2>
        <p><strong>Company Name:</strong> <span id="company_name"></span></p>
        <p><strong>Baseline RMSE:</strong> <span id="baseline_rmse"></span></p>
        <p><strong>Baseline R² Score:</strong> <span id="baseline_r2"></span></p>
        <p><strong>Sentiment Effect on Prediction:</strong> <span id="sentiment_effect"></span></p>
        <p><strong>Sentiment RMSE:</strong> <span id="sentiment_rmse"></span></p>
        <p><strong>Sentiment R² Score:</strong> <span id="sentiment_r2"></span></p>
        <p><strong>Final Model RMSE:</strong> <span id="final_rmse"></span></p>
        <p><strong>Final Model R² Score:</strong> <span id="final_r2"></span></p>
        <p><strong>Predicted Next Day Price:</strong> <span id="predicted_price"></span></p>
        <p><strong>Historical Data Count:</strong> <span id="historical_count"></span></p>
        <p><strong>Sentiment Data Count:</strong> <span id="sentiment_count"></span></p>
    </div>
</div>

<script>
document.getElementById("stockForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    const ticker = document.getElementById("ticker").value.trim();
    const loading = document.getElementById("loading");
    const errorMsg = document.getElementById("error-message");
    const results = document.getElementById("results");

    loading.style.display = "block";
    errorMsg.textContent = "";
    results.style.display = "none";

    try {
        const response = await fetch(`/api/analytics-data/?ticker=${ticker}`);
        const data = await response.json();

        loading.style.display = "none";

        if (!response.ok) {
            errorMsg.textContent = data.error || "Something went wrong. Please try again.";
            return;
        }

        document.getElementById("ticker").textContent = data.ticker;
        document.getElementById("company_name").textContent = data.company_name;
        document.getElementById("baseline_rmse").textContent = data.baseline_rmse.toFixed(4);
        document.getElementById("baseline_r2").textContent = data.baseline_r2.toFixed(4);
        document.getElementById("sentiment_effect").textContent = data.sentiment_effect_pred.toFixed(4);
        document.getElementById("sentiment_rmse").textContent = data.sentiment_rmse.toFixed(4);
        document.getElementById("sentiment_r2").textContent = data.sentiment_r2.toFixed(4);
        document.getElementById("final_rmse").textContent = data.final_rmse.toFixed(4);
        document.getElementById("final_r2").textContent = data.final_r2.toFixed(4);
        document.getElementById("predicted_price").textContent = `$${data.baseline_pred_next_close.toFixed(2)}`;
        document.getElementById("historical_count").textContent = data.price_history_days;
        document.getElementById("sentiment_count").textContent = data.sentiment_days_available;

        results.style.display = "block";
    } catch (error) {
        loading.style.display = "none";
        errorMsg.textContent = "Failed to fetch data. Check your connection.";
    }
});
</script>
{% endblock %}
